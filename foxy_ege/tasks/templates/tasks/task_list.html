{% extends "base.html" %}
{% load static task_tags %}
{% load static custom_filters %}
{% block title %}
    –ë–∞–Ω–∫ –∑–∞–¥–∞–Ω–∏–π - {{ subject|title }} - FoxyEGE.ru
{% endblock %}

{% block og_title %}
    –ë–∞–Ω–∫ –∑–∞–¥–∞–Ω–∏–π - {{ subject|title }} - FoxyEGE.ru
{% endblock %}
{% block og_description %}
    –ë–∞–Ω–∫ –∑–∞–¥–∞–Ω–∏–π –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ï–ì–≠ –ø–æ {{ subject|title }}. –§–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ —Ç–µ–º–∞–º, –ø–æ–¥—Ç–µ–º–∞–º –∏ –Ω–æ–º–µ—Ä–∞–º –∑–∞–¥–∞–Ω–∏–π.
{% endblock %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/new_task_list.css' %}">
    <style>
        .solution-step {
            margin-bottom: 15px;
        }
    </style>
{% endblock %}

{% block content %}
    <h1>–ë–∞–Ω–∫ –∑–∞–¥–∞–Ω–∏–π</h1>

    <div id="generator-settings">
        <h2>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä</h2>
        <form method="GET" action="{% url 'tasks:task_list' subject=subject %}">
            <div class="filter-item">
                <button type="button" class="toggle-button" data-target="parts" aria-expanded="false">–ß–∞—Å—Ç–∏ —ç–∫–∑–∞–º–µ–Ω–∞</button>
                <div id="parts" class="filter-section" style="display: none;">
                    <ul class="filter-options">
                        <li>
                            <input type="radio" name="exam_part" value="" id="exam_part_all" {% if not request.GET.exam_part %}checked{% endif %}>
                            <label for="exam_part_all">–í—Å–µ —á–∞—Å—Ç–∏</label>
                        </li>
                        {% for part in exam_parts %}
                            <li>
                                <input type="radio" name="exam_part" value="{{ part.id }}" id="exam_part_{{ part.id }}" {% if request.GET.exam_part == part.id|stringformat:"s" %}checked{% endif %}>
                                <label for="exam_part_{{ part.id }}">{{ part.name }}</label>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="filter-item">
                <button type="button" class="toggle-button" data-target="exam_lines" aria-expanded="false">–ó–∞–¥–∞–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞</button>
                <div id="exam_lines" class="filter-section" style="display: none;">
                    <ul class="filter-options">
                        <li>
                            <input type="radio" name="exam_line" value="" id="exam_line_all" {% if not request.GET.exam_line %}checked{% endif %}>
                            <label for="exam_line_all">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è</label>
                        </li>
                        {% for line in exam_lines %}
                            <li>
                                <input type="radio" name="exam_line" value="{{ line.id }}" id="exam_line_{{ line.id }}" {% if request.GET.exam_line == line.id|stringformat:"s" %}checked{% endif %}>
                                <label for="exam_line_{{ line.id }}">–ó–∞–¥–∞–Ω–∏–µ {{ line.number }}</label>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="filter-item">
                <button type="button" class="toggle-button" data-target="topics" aria-expanded="false">–¢–µ–º—ã</button>
                <div id="topics" class="filter-section" style="display: none;">
                    <ul class="filter-options">
                        <li>
                            <input type="radio" name="topic" value="" id="topic_all" {% if not request.GET.topic %}checked{% endif %}>
                            <label for="topic_all">–í—Å–µ —Ç–µ–º—ã</label>
                        </li>
                        {% for topic in topics %}
                            <li>
                                <input type="radio" name="topic" value="{{ topic.id }}" id="topic_{{ topic.id }}" {% if request.GET.topic == topic.id|stringformat:"s" %}checked{% endif %}>
                                <label for="topic_{{ topic.id }}">{{ topic.name }}</label>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="filter-item">
                <button type="button" class="toggle-button" data-target="subtopics" aria-expanded="false">–ü–æ–¥—Ç–µ–º—ã</button>
                <div id="subtopics" class="filter-section" style="display: none;">
                    <ul class="filter-options">
                        <li>
                            <input type="radio" name="subtopic" value="" id="subtopic_all" {% if not request.GET.subtopic %}checked{% endif %}>
                            <label for="subtopic_all">–í—Å–µ –ø–æ–¥—Ç–µ–º—ã</label>
                        </li>
                        {% for subtopic in subtopics %}
                            <li>
                                <input type="radio" name="subtopic" value="{{ subtopic.id }}" id="subtopic_{{ subtopic.id }}" {% if request.GET.subtopic == subtopic.id|stringformat:"s" %}checked{% endif %}>
                                <label for="subtopic_{{ subtopic.id }}">{{ subtopic.name }}</label>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="filter-item">
                <button type="button" class="toggle-button" data-target="sources" aria-expanded="false">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</button>
                <div id="sources" class="filter-section" style="display: none;">
                    <ul class="filter-options">
                        <li>
                            <input type="radio" name="source" value="" id="source_all" {% if not request.GET.source %}checked{% endif %}>
                            <label for="source_all">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</label>
                        </li>
                        {% for source in sources %}
                            <li>
                                <input type="radio" name="source" value="{{ source.id }}" id="source_{{ source.id }}" {% if request.GET.source == source.id|stringformat:"s" %}checked{% endif %}>
                                <label for="source_{{ source.id }}">{{ source.name }}</label>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="filter-item">
                <label for="search_text">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É:</label>
                <input type="text" name="search_text" id="search_text" value="{{ request.GET.search_text|default:'' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞">
            </div>

            <div class="filter-item">
                <label for="per_page">–ó–∞–¥–∞–Ω–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()">
                    <option value="20" {% if per_page == "20" %}selected{% endif %}>20</option>
                    <option value="50" {% if per_page == "50" %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == "100" %}selected{% endif %}>100</option>
                </select>
            </div>

            <div class="filter-actions">
                <button type="submit" class="filter-button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="{% url 'tasks:task_list' subject=subject %}" class="filter-button reset-button">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>

        {% if request.GET %}
            <div class="selected-filters">
                <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h3>
                <ul>
                    {% if request.GET.exam_part %}
                        <li>–ß–∞—Å—Ç—å —ç–∫–∑–∞–º–µ–Ω–∞: {% with part=exam_parts|get_item:request.GET.exam_part %}{{ part.name|default:"–í—Å–µ —á–∞—Å—Ç–∏" }}{% endwith %}</li>
                    {% endif %}
                    {% if request.GET.exam_line %}
                        <li>–ó–∞–¥–∞–Ω–∏–µ: {% with line=exam_lines|get_item:request.GET.exam_line %}–ó–∞–¥–∞–Ω–∏–µ {{ line.number|default:"–í—Å–µ –∑–∞–¥–∞–Ω–∏—è" }}{% endwith %}</li>
                    {% endif %}
                    {% if request.GET.topic %}
                        <li>–¢–µ–º–∞: {% with topic=topics|get_item:request.GET.topic %}{{ topic.name|default:"–í—Å–µ —Ç–µ–º—ã" }}{% endwith %}</li>
                    {% endif %}
                    {% if request.GET.subtopic %}
                        <li>–ü–æ–¥—Ç–µ–º–∞: {% with subtopic=subtopics|get_item:request.GET.subtopic %}{{ subtopic.name|default:"–í—Å–µ –ø–æ–¥—Ç–µ–º—ã" }}{% endwith %}</li>
                    {% endif %}
                    {% if request.GET.source %}
                        <li>–ò—Å—Ç–æ—á–Ω–∏–∫: {% with source=sources|get_item:request.GET.source %}{{ source.name|default:"–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏" }}{% endwith %}</li>
                    {% endif %}
                    {% if request.GET.search_text %}
                        <li>–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É: {{ request.GET.search_text }}</li>
                    {% endif %}
                    <li>–ó–∞–¥–∞–Ω–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {{ per_page }}</li>
                </ul>
            </div>
        {% endif %}

        <div style="margin-top: 20px; text-align: right;">
            <a href="{% url 'tasks:print_settings' subject=subject %}?{% for key, value in request.GET.items %}{{ key }}={{ value }}&{% endfor %}" class="print-btn" target="_blank">
                <img src="{% static 'images/print_icon.png' %}" alt="Print" style="width: 70px; vertical-align: middle;"> –í–µ—Ä—Å–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏
            </a>
        </div>
    </div>

    <hr>

    {% if tasks %}
    <ul class="task-list">
        {% for task in tasks %}
            <li class="task-item">
                <a href="{% url 'tasks:task_detail' subject=subject unique_id=task.unique_id %}">
                    {{ task.exam_line|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}, (‚Ññ{{ task.unique_id }} –≤ –±–∞–Ω–∫–µ –∑–∞–¥–∞–Ω–∏–π)
                </a>
                <button class="favorite-button {% if task.unique_id in favorite_task_ids %}favorite-active{% endif %}" data-task-id="{{ task.unique_id }}">{% if task.unique_id in favorite_task_ids %}‚òÖ{% else %}‚òÜ{% endif %}</button>
                <div class="task-content">
                    <div class="task-text-content">
                        <div class="task-text">
                            {{ task.text_svg|safe|default:task.text }}
                        </div>
                        {% if task.latex_formula_svg %}
                            <div class="latex-formula">
                                {{ task.latex_formula_svg|safe }}
                            </div>
                        {% endif %}
                    </div>
                    {% if task.image %}
                        <div class="task-image-container">
                            <img 
                                src="{{ task.image.url }}" 
                                alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –∑–∞–¥–∞–Ω–∏—é" 
                                class="task-image"
                                data-exam-line="{{ task.exam_line.number }}"
                            >
                        </div>
                    {% endif %}
                </div>
                <div class="task-buttons">
                    {% if task.has_solution %}
                        <button class="solution-button" data-task-id="{{ task.unique_id }}">–†–µ—à–µ–Ω–∏–µ</button>
                    {% else %}
                        <p>–†–µ—à–µ–Ω–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
                    {% endif %}
                    <span class="info-icon" data-task-id="{{ task.unique_id }}">‚ÑπÔ∏è</span>
                    <button class="print-cart-button" data-task-id="{{ task.unique_id }}" data-task-title="{{ task.exam_line|default:'–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}, (‚Ññ{{ task.unique_id }})">üñ®Ô∏è</button>
                </div>
                {% if task.has_solution %}
                    <div id="solution-{{ task.unique_id }}" class="solution-content">
                        {% if task.solution_text_svg %}
                            <div class="solution-text">
                                {% for step in task.solution_text_svg|split_steps %}
                                    <div class="solution-step">
                                        {{ step|safe }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% for solution_image in task.solution_images.all %}
                            <div class="solution-image">
                                <img src="{{ solution_image.image.url }}" style="width: {{ solution_image.width }}px;" alt="Solution image">
                            </div>
                        {% endfor %}
                        {% if task.answer %}
                            <p><strong>–û—Ç–≤–µ—Ç:</strong> {{ task.answer }}</p>
                        {% endif %}
                    </div>
                {% endif %}
                <div id="info-{{ task.unique_id }}" class="info-box">
                    <p><strong>–¢–µ–º–∞:</strong> {{ task.topic|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</p>
                    <p><strong>–ü–æ–¥—Ç–µ–º–∞:</strong> {{ task.subtopic|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</p>
                    <p><strong>–ó–∞–¥–∞–Ω–∏–µ:</strong> {{ task.exam_line|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</p>
                    <p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> {{ task.source|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
                </div>
            </li>
        {% endfor %}
    </ul>
        {% include "tasks/pagination.html" %}
    {% else %}
        <p>–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
    {% endif %}
    <div id="print-cart" class="print-cart">
        <button id="print-cart-toggle">üñ®Ô∏è <span id="print-cart-count">0</span></button>
        <div id="print-cart-content" class="print-cart-content">
            <h3>–ö–æ—Ä–∑–∏–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏</h3>
            <ul id="print-cart-items"></ul>
            <div class="print-cart-actions">
                <button id="print-cart-print" class="filter-button">–ü–µ—á–∞—Ç—å</button>
                <button id="print-cart-clear" class="filter-button reset-button">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrfToken = getCookie('csrftoken');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const toggleButtons = document.querySelectorAll('.toggle-button');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation(); // –î–æ–±–∞–≤–ª–µ–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –≤—Å–ø–ª—ã—Ç–∏–µ
                    console.log('Button clicked:', this); // –ª–æ–≥
                    const targetId = this.getAttribute('data-target');
                    const section = document.getElementById(targetId);
                    if (!section) {
                        console.error(`–°–µ–∫—Ü–∏—è —Å ID ${targetId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                        return;
                    }
                    const isVisible = section.style.display === 'block';
                    document.querySelectorAll('.filter-section').forEach(sec => {
                        sec.style.display = 'none';
                        const relatedButton = sec.previousElementSibling;
                        if (relatedButton && relatedButton.classList.contains('toggle-button')) {
                            relatedButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                    section.style.display = isVisible ? 'none' : 'block';
                    this.setAttribute('aria-expanded', isVisible ? 'false' : 'true');
                    console.log('aria-expanded set to:', this.getAttribute('aria-expanded')); // –ª–æ–≥
                });
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function(event) {
                const isClickInside = event.target.closest('.filter-item') || event.target.closest('.filter-section');
                if (!isClickInside) {
                    document.querySelectorAll('.filter-section').forEach(section => {
                        section.style.display = 'none';
                        const toggleButton = section.previousElementSibling;
                        if (toggleButton && toggleButton.classList.contains('toggle-button')) {
                            toggleButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–†–µ—à–µ–Ω–∏–µ"
            const solutionButtons = document.querySelectorAll('.solution-button');
            solutionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    const solutionContent = document.getElementById(`solution-${taskId}`);
                    if (solutionContent) {
                        if (solutionContent.style.display === 'none' || !solutionContent.style.display) {
                            solutionContent.style.display = 'block';
                            this.textContent = '–°–∫—Ä—ã—Ç—å —Ä–µ—à–µ–Ω–∏–µ';
                        } else {
                            solutionContent.style.display = 'none';
                            this.textContent = '–†–µ—à–µ–Ω–∏–µ';
                        }
                    }
                });
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            const infoIcons = document.querySelectorAll('.info-icon');
            infoIcons.forEach(icon => {
                icon.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    const infoBox = document.getElementById(`info-${taskId}`);
                    if (infoBox) {
                        if (infoBox.style.display === 'none' || !infoBox.style.display) {
                            infoBox.style.display = 'block';
                        } else {
                            infoBox.style.display = 'none';
                        }
                    }
                });
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
            const favoriteButtons = document.querySelectorAll('.favorite-button');
            favoriteButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const isAuthenticated = {{ user.is_authenticated|lower }};
                    if (!isAuthenticated) {
                        const authButton = document.getElementById('authButton');
                        if (authButton) authButton.click();
                        return;
                    }
                    const taskId = this.getAttribute('data-task-id');
                    const formData = new URLSearchParams();
                    formData.append('task_id', taskId);
                    try {
                        const response = await fetch("{% url 'tasks:toggle_favorite' subject=subject %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': csrfToken,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData.toString(),
                            credentials: 'same-origin'
                        });
                        if (response.redirected) {
                            window.location.href = response.url;
                            return;
                        }
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();
                        if (data.success) {
                            this.classList.toggle('favorite-active', data.is_favorite);
                            this.textContent = data.is_favorite ? '‚òÖ' : '‚òÜ';
                            if (data.message) {
                                const messageDiv = document.createElement('div');
                                messageDiv.textContent = data.message;
                                messageDiv.style.position = 'fixed';
                                messageDiv.style.top = '20px';
                                messageDiv.style.right = '20px';
                                messageDiv.style.padding = '10px';
                                messageDiv.style.backgroundColor = '#4CAF50';
                                messageDiv.style.color = 'white';
                                messageDiv.style.borderRadius = '5px';
                                messageDiv.style.zIndex = '1000';
                                document.body.appendChild(messageDiv);
                                setTimeout(() => messageDiv.remove(), 3000);
                            }
                        } else {
                            console.error('Error:', data.error);
                            alert(data.error);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                    }
                });
            });

            // –õ–æ–≥–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –ø–µ—á–∞—Ç–∏
            let printCart = JSON.parse(localStorage.getItem('printCart')) || [];
            const printCartItems = document.getElementById('print-cart-items');
            const printCartCount = document.getElementById('print-cart-count');
            const printCartToggle = document.getElementById('print-cart-toggle');
            const printCartContent = document.getElementById('print-cart-content');
            const printCartPrint = document.getElementById('print-cart-print');
            const printCartClear = document.getElementById('print-cart-clear');
            const printCartContainer = document.getElementById('print-cart');

            const taskDetailUrlBase = "{% url 'tasks:task_detail' subject=subject unique_id='TASK_ID_PLACEHOLDER' %}";

            updatePrintCart();

            document.querySelectorAll('.print-cart-button').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.dataset.taskId;
                    const taskTitle = this.dataset.taskTitle;
                    if (!printCart.some(item => item.id === taskId)) {
                        printCart.push({ id: taskId, title: taskTitle });
                        localStorage.setItem('printCart', JSON.stringify(printCart));
                        updatePrintCart();
                    }
                });
            });

            function updatePrintCart() {
                printCartItems.innerHTML = '';
                printCart.forEach(item => {
                    const li = document.createElement('li');
                    const taskUrl = taskDetailUrlBase.replace('TASK_ID_PLACEHOLDER', item.id);
                    li.innerHTML = `
                        <a href="${taskUrl}" target="_blank">${item.title}</a>
                        <button class="print-cart-remove" data-task-id="${item.id}">‚úñ</button>
                    `;
                    printCartItems.appendChild(li);
                });
                printCartCount.textContent = printCart.length;

                document.querySelectorAll('.print-cart-remove').forEach(button => {
                    button.addEventListener('click', function() {
                        const taskId = this.dataset.taskId;
                        printCart = printCart.filter(item => item.id !== taskId);
                        localStorage.setItem('printCart', JSON.stringify(printCart));
                        updatePrintCart();
                    });
                });
            }

            printCartToggle.addEventListener('click', function() {
                printCartContent.style.display = printCartContent.style.display === 'block' ? 'none' : 'block';
            });

            printCartPrint.addEventListener('click', function() {
                if (printCart.length === 0) {
                    alert('–ö–æ—Ä–∑–∏–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏ –ø—É—Å—Ç–∞!');
                    return;
                }
                const taskIds = printCart.map(item => `task_ids=${item.id}`).join('&');
                window.open(`{% url 'tasks:print_settings_cart' subject=subject %}?${taskIds}`, '_blank');
            });

            printCartClear.addEventListener('click', function() {
                printCart = [];
                localStorage.setItem('printCart', JSON.stringify(printCart));
                updatePrintCart();
            });

            document.addEventListener('click', function(event) {
                if (!printCartContainer.contains(event.target) && !event.target.closest('.print-cart-button')) {
                    printCartContent.style.display = 'none';
                }
            });
        });
    </script>
{% endblock %}