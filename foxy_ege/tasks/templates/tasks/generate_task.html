{% extends "base.html" %}
{% load static custom_filters task_tags %}

{% block title %}
    –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏–π
{% endblock %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/generate_task.css' %}">
    <style>
        .filter-item { margin-bottom: 15px; }
        .generate-toggle-button {
            padding: 10px 15px;
            background-color: #ff6f61;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            position: relative; /* –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ::after */
        }
        .generate-toggle-button:hover { background-color: #ff9a8b; }
        .generate-toggle-button::after {
            content: " ‚ñº";
            margin-left: 8px;
            transition: transform 0.3s ease;
            display: inline-block; /* –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
        }
        .generate-toggle-button[aria-expanded="true"]::after {
            transform: rotate(180deg);
        }
        .filter-section {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .filter-actions { display: flex; gap: 10px; margin-top: 20px; }
        .filter-button {
            padding: 10px 20px;
            background-color: #ff6f61;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .filter-button:hover { background-color: #ff9a8b; }
        .reset-button { background-color: #ddd; color: #333; }
        .reset-button:hover { background-color: #ccc; }
        .task-count-container input {
            width: 60px;
            padding: 5px;
            border: 2px solid #ff6f61;
            border-radius: 5px;
        }
        .selected-filters { margin-top: 20px; padding: 15px; background: #fff; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .selected-filters ul { list-style: none; padding: 0; }
        ul { padding-left: 20px; }
        li { margin-bottom: 15px; }
        #check-tasks {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #ff6f61;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #check-tasks:hover { background-color: #ff9a8b; }
        #results-table table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #results-table th, #results-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        #results-table th { background-color: #f5f5f5; }
    </style>
{% endblock %}

{% block content %}
    <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏–π</h1>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ -->
    <div id="generator-settings">
        <h2>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∑–∞–¥–∞–Ω–∏–π</h2>
        <form method="GET" action="{% url 'tasks:generate_task' subject=subject %}" id="generate-task-form">
            <!-- –ß–µ–∫–±–æ–∫—Å "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" -->
            <div class="filter-item">
                <label>
                    <input type="checkbox" id="generate-select-all" name="select_all">
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </label>
            </div>

            <!-- –ß–∞—Å—Ç–∏ —ç–∫–∑–∞–º–µ–Ω–∞ -->
            <div class="filter-item">
                <button type="button" class="generate-toggle-button" data-target="generate-parts" aria-expanded="false">
                    –ß–∞—Å—Ç–∏ —ç–∫–∑–∞–º–µ–Ω–∞
                </button>
                <div id="generate-parts" class="filter-section">
                    {{ form.parts }}
                </div>
            </div>

            <!-- –ó–∞–¥–∞–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞ -->
            <div class="filter-item">
                <button type="button" class="generate-toggle-button" data-target="generate-exam_lines" aria-expanded="false">
                    –ó–∞–¥–∞–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞
                </button>
                <div id="generate-exam_lines" class="filter-section">
                    {{ form.exam_lines }}
                </div>
            </div>

            <!-- –¢–µ–º—ã -->
            <div class="filter-item">
                <button type="button" class="generate-toggle-button" data-target="generate-topics" aria-expanded="false">
                    –¢–µ–º—ã
                </button>
                <div id="generate-topics" class="filter-section">
                    {{ form.topics }}
                </div>
            </div>

            <!-- –ü–æ–¥—Ç–µ–º—ã -->
            <div class="filter-item">
                <button type="button" class="generate-toggle-button" data-target="generate-subtopics" aria-expanded="false">
                    –ü–æ–¥—Ç–µ–º—ã
                </button>
                <div id="generate-subtopics" class="filter-section">
                    {{ form.subtopics }}
                </div>
            </div>

            <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ -->
            <div class="filter-item">
                <button type="button" class="generate-toggle-button" data-target="generate-sources" aria-expanded="false">
                    –ò—Å—Ç–æ—á–Ω–∏–∫–∏
                </button>
                <div id="generate-sources" class="filter-section">
                    {{ form.sources }}
                </div>
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π -->
            <div class="filter-item task-count-container">
                <label for="id_task_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π:</label>
                {{ form.task_count }}
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="filter-actions">
                <button type="submit" id="generate-tasks" class="filter-button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>
                <a href="{% url 'tasks:generate_task' subject=subject %}" class="filter-button reset-button">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
            </div>
        </form>

        <div style="margin-top: 20px; text-align: right;">
            {% if tasks %}
                <script>
                    console.log('Generated tasks count:', {{ tasks|length }});
                    {% for task in tasks %}
                        console.log('Generated Task ID:', '{{ task.unique_id }}');
                    {% endfor %}
                </script>
                <a href="{% url 'tasks:print_settings_gentask' subject=subject %}?{% for task in tasks %}task_ids={{ task.unique_id }}&{% endfor %}" class="print-btn" target="_blank">
                    <img src="{% static 'images/print_icon.png' %}" alt="Print" style="width: 70px; vertical-align: middle;"> –í–µ—Ä—Å–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏
                </a>
            {% else %}
                <a href="{% url 'tasks:print_settings' subject=subject %}?{% for key, value in request.GET.items %}{{ key }}={{ value }}&{% endfor %}" class="print-btn" target="_blank">
                    <img src="{% static 'images/print_icon.png' %}" alt="Print" style="width: 70px; vertical-align: middle;"> –í–µ—Ä—Å–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏
                </a>
            {% endif %}
        </div>
    </div>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    {% if form.is_bound and form.is_valid %}
        <div class="selected-filters">
            <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h3>
            <ul>
                {% if form.cleaned_data.parts %}
                    <li>–ß–∞—Å—Ç–∏ —ç–∫–∑–∞–º–µ–Ω–∞: {{ form.cleaned_data.parts|join:", " }}</li>
                {% endif %}
                {% if form.cleaned_data.exam_lines %}
                    <li>–ó–∞–¥–∞–Ω–∏—è —ç–∫–∑–∞–º–µ–Ω–∞: {{ form.cleaned_data.exam_lines|join:", " }}</li>
                {% endif %}
                {% if form.cleaned_data.topics %}
                    <li>–¢–µ–º—ã: {{ form.cleaned_data.topics|join:", " }}</li>
                {% endif %}
                {% if form.cleaned_data.subtopics %}
                    <li>–ü–æ–¥—Ç–µ–º—ã: {{ form.cleaned_data.subtopics|join:", " }}</li>
                {% endif %}
                {% if form.cleaned_data.sources %}
                    <li>–ò—Å—Ç–æ—á–Ω–∏–∫–∏: {{ form.cleaned_data.sources|join:", " }}</li>
                {% endif %}
                {% if form.cleaned_data.task_count %}
                    <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π: {{ form.cleaned_data.task_count }}</li>
                {% endif %}
            </ul>
        </div>
    {% endif %}
</div>

<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
{% if error_message %}
    <p style="color: #ff6f61;">{{ error_message }}</p>
{% endif %}

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π -->
{% if tasks %}
    <h2>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
    <ul>
        {% for task in tasks %}
            <li>
                <!-- –°–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Ä–æ–±–æ—Ç–æ–≤ -->
                <div style="display: none;">
                    <div class="hidden-text">{{ task.text }}</div>
                    {% if task.latex_formula %}
                        <div class="hidden-latex">{{ task.latex_formula }}</div>
                    {% endif %}
                </div>
                <a href="{% url 'tasks:task_detail' subject=subject unique_id=task.unique_id %}">
                    {{ task.exam_line }}, (‚Ññ{{ task.unique_id }} –≤ –±–∞–Ω–∫–µ –∑–∞–¥–∞–Ω–∏–π)
                </a>
                <p>{{ task.text_svg|safe|default:task.text|safe }}</p>
                {% if task.image %}
                    <div class="task-image-container">
                        <img 
                            src="{{ task.image.url }}" 
                            alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –∑–∞–¥–∞–Ω–∏—é" 
                            class="task-image"
                            {% if task.exam_line.number == 1 %}
                                style="max-width: 100px; height: auto;"
                            {% elif task.exam_line.number == 2 %}
                                style="max-width: 400px; height: auto;"
                            {% elif task.exam_line.number == 3 %}
                                style="max-width: 100px; height: auto;"
                            {% elif task.exam_line.number == 8 %}
                                style="max-width: 700px; height: auto;"
                            {% elif task.exam_line.number == 11 %}
                                style="max-width: 300px; height: auto;"
                            {% else %}
                                style="max-width: 100%; height: auto;"
                            {% endif %}
                        >
                    </div>
                {% endif %}
                {% if task.exam_part.name == "–ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å" %}
                    <label for="answer-{{ task.unique_id }}">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                    <input type="text" 
                           id="answer-{{ task.unique_id }}" 
                           class="user-answer" 
                           data-correct="{{ task.answer }}" 
                           data-line-number="{{ task.exam_line.number }}" 
                           data-unique-id="{{ task.unique_id }}">
                {% endif %}
                <button class="print-cart-button" data-task-id="{{ task.unique_id }}" data-task-title="{{ task.exam_line|default:'–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}, (‚Ññ{{ task.unique_id }})">üñ®Ô∏è</button>
            </li>
        {% endfor %}
    </ul>

    <!-- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è" -->
    <button id="check-tasks">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ -->
    <div id="results-table" style="display: none;">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>–ó–∞–¥–∞–Ω–∏–µ</th>
                    <th>–í–∞—à –æ—Ç–≤–µ—Ç</th>
                    <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</th>
                </tr>
            </thead>
            <tbody id="results-body">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </tbody>
        </table>

        <!-- –†–µ—à–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏ -->
        <div id="second-part-solutions" style="display: none;">
            <h2>–†–µ—à–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏</h2>
            <ul>
                {% for task in tasks %}
                    {% if task.exam_part.name == "–í—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å" and task.has_solution %}
                        <li>
                            <strong>–ó–∞–¥–∞–Ω–∏–µ {{ task.exam_line.number }}:</strong>
                            {% if task.solution_text_svg %}
                                <div class="solution-text">
                                    {% for step in task.solution_text_svg|split_steps %}
                                        <div class="solution-step">
                                            {{ step|safe }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if task.answer %}
                                <p><strong>–û—Ç–≤–µ—Ç:</strong> {{ task.answer }}</p>
                            {% endif %}
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
{% endif %}

<div id="print-cart">
    <button id="print-cart-toggle">üñ®Ô∏è <span id="print-cart-count">0</span></button>
    <div id="print-cart-content" class="print-cart-content">
        <h3>–ö–æ—Ä–∑–∏–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏</h3>
        <ul id="print-cart-items"></ul>
        <div class="print-cart-actions">
            <button id="print-cart-print" class="filter-button">–ü–µ—á–∞—Ç—å</button>
            <button id="print-cart-clear" class="filter-button reset-button">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        (function() {
            'use strict';

            document.addEventListener('DOMContentLoaded', function() {
                console.log('Generate Task DOM loaded');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                function updateSelectAll() {
                    const selectAll = document.getElementById('generate-select-all');
                    if (selectAll) {
                        const checkboxes = document.querySelectorAll('#generate-task-form .filter-section input[type="checkbox"]');
                        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                        selectAll.checked = allChecked;
                    }
                }
                updateSelectAll();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const toggleButtons = document.querySelectorAll('.generate-toggle-button');
                toggleButtons.forEach(button => {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        const targetId = this.getAttribute('data-target');
                        const section = document.getElementById(targetId);
                        if (!section) {
                            console.error(`–°–µ–∫—Ü–∏—è —Å ID ${targetId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                            return;
                        }
                        const isVisible = section.style.display === 'block';
                        document.querySelectorAll('.filter-section').forEach(sec => {
                            sec.style.display = 'none';
                            sec.previousElementSibling.setAttribute('aria-expanded', 'false');
                        });
                        section.style.display = isVisible ? 'none' : 'block';
                        this.setAttribute('aria-expanded', isVisible ? 'false' : 'true');
                    });
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
                document.addEventListener('click', function(event) {
                    const isClickInside = event.target.closest('.filter-item') || event.target.closest('.filter-section');
                    if (!isClickInside) {
                        document.querySelectorAll('.filter-section').forEach(section => {
                            section.style.display = 'none';
                            section.previousElementSibling.setAttribute('aria-expanded', 'false');
                        });
                    }
                });

                // –ß–µ–∫–±–æ–∫—Å "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
                const selectAllCheckbox = document.getElementById('generate-select-all');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', function(event) {
                        event.stopPropagation();
                        const isChecked = this.checked;
                        document.querySelectorAll('#generate-task-form .filter-section input[type="checkbox"]').forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                    });
                }

                document.querySelectorAll('#generate-task-form .filter-section input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updateSelectAll();
                    });
                });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏–π
                const checkTasksButton = document.getElementById('check-tasks');
                if (checkTasksButton) {
                    checkTasksButton.addEventListener('click', function() {
                        const resultsTable = document.getElementById('results-table');
                        const secondPartSolutions = document.getElementById('second-part-solutions');
                        const resultsBody = document.getElementById('results-body');
                        if (resultsTable && secondPartSolutions && resultsBody) {
                            resultsBody.innerHTML = '';
                            document.querySelectorAll('.user-answer').forEach(input => {
                                const taskUniqueId = input.dataset.uniqueId;
                                const lineNumber = input.dataset.lineNumber;
                                const userAnswer = input.value.trim();
                                const correctAnswer = input.dataset.correct;

                                const row = document.createElement('tr');
                                const taskCell = document.createElement('td');
                                const taskLink = document.createElement('a');
                                taskLink.href = "{% url 'tasks:task_detail' subject=subject unique_id='REPLACE_ME' %}".replace('REPLACE_ME', taskUniqueId);
                                taskLink.textContent = `–ó–∞–¥–∞–Ω–∏–µ ‚Ññ${lineNumber}`;
                                taskCell.appendChild(taskLink);
                                row.appendChild(taskCell);

                                const userAnswerCell = document.createElement('td');
                                userAnswerCell.textContent = userAnswer || '–ù–µ —É–∫–∞–∑–∞–Ω';
                                userAnswerCell.style.color = userAnswer === correctAnswer ? 'green' : 'red';
                                row.appendChild(userAnswerCell);

                                const correctAnswerCell = document.createElement('td');
                                correctAnswerCell.textContent = correctAnswer || '–û—Ç–≤–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω';
                                row.appendChild(correctAnswerCell);

                                resultsBody.appendChild(row);
                            });

                            resultsTable.style.display = 'block';
                            secondPartSolutions.style.display = 'block';
                        }
                    });
                }

                // –õ–æ–≥–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –ø–µ—á–∞—Ç–∏
                const printCartItems = document.getElementById('print-cart-items');
                const printCartCount = document.getElementById('print-cart-count');
                const printCartToggle = document.getElementById('print-cart-toggle');
                const printCartContent = document.getElementById('print-cart-content');
                const printCartPrint = document.getElementById('print-cart-print');
                const printCartClear = document.getElementById('print-cart-clear');
                const printCartContainer = document.getElementById('print-cart');

                if (!printCartItems || !printCartCount || !printCartToggle || !printCartContent || !printCartPrint || !printCartClear || !printCartContainer) {
                    console.error('One or more print cart elements are missing');
                    return;
                }

                let printCart = JSON.parse(localStorage.getItem('printCart')) || [];
                const taskDetailUrlBase = "{% url 'tasks:task_detail' subject=subject unique_id='TASK_ID_PLACEHOLDER' %}";

                updatePrintCart();

                document.querySelectorAll('.print-cart-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const taskId = this.dataset.taskId;
                        const taskTitle = this.dataset.taskTitle;
                        if (!printCart.some(item => item.id === taskId)) {
                            printCart.push({ id: taskId, title: taskTitle });
                            localStorage.setItem('printCart', JSON.stringify(printCart));
                            updatePrintCart();
                            console.log('Added to printCart:', { id: taskId, title: taskTitle });
                        } else {
                            console.log('Task already in printCart:', taskId);
                        }
                    });
                });

                function updatePrintCart() {
                    printCartItems.innerHTML = '';
                    printCart.forEach(item => {
                        const li = document.createElement('li');
                        const taskUrl = taskDetailUrlBase.replace('TASK_ID_PLACEHOLDER', item.id);
                        li.innerHTML = `
                            <a href="${taskUrl}" target="_blank">${item.title}</a>
                            <button class="print-cart-remove" data-task-id="${item.id}">‚úñ</button>
                        `;
                        printCartItems.appendChild(li);
                    });
                    printCartCount.textContent = printCart.length;
                    console.log('Updated printCart:', printCart);

                    document.querySelectorAll('.print-cart-remove').forEach(button => {
                        button.addEventListener('click', function() {
                            const taskId = this.dataset.taskId;
                            printCart = printCart.filter(item => item.id !== taskId);
                            localStorage.setItem('printCart', JSON.stringify(printCart));
                            updatePrintCart();
                        });
                    });
                }

                printCartToggle.addEventListener('click', function() {
                    printCartContent.style.display = printCartContent.style.display === 'block' ? 'none' : 'block';
                });

                printCartPrint.addEventListener('click', function() {
                    console.log('Print cart contents before printing:', printCart);
                    if (printCart.length === 0) {
                        alert('–ö–æ—Ä–∑–∏–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏ –ø—É—Å—Ç–∞!');
                        return;
                    }
                    const taskIds = printCart.map(item => `task_ids=${item.id}`).join('&');
                    const url = `{% url 'tasks:print_settings_cart' subject=subject %}?${taskIds}`;
                    console.log('Generated URL for print:', url);
                    window.open(url, '_blank');
                });

                printCartClear.addEventListener('click', function() {
                    printCart = [];
                    localStorage.setItem('printCart', JSON.stringify(printCart));
                    updatePrintCart();
                    console.log('Print cart cleared');
                });

                document.addEventListener('click', function(event) {
                    if (!printCartContainer.contains(event.target) && !event.target.closest('.print-cart-button')) {
                        printCartContent.style.display = 'none';
                    }
                });

                // –ö–Ω–æ–ø–∫–∞ "–í–µ—Ä—Å–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏"
                const printVersionButton = document.getElementById('print-version');
                if (printVersionButton) {
                    printVersionButton.addEventListener('click', function() {
                        const taskIds = Array.from(document.querySelectorAll('.task-item')).map(item => item.dataset.taskId);
                        if (taskIds.length === 0) {
                            alert('–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –¥–ª—è –ø–µ—á–∞—Ç–∏!');
                            return;
                        }
                        const url = `{% url 'tasks:print_settings_gentask' subject=subject %}?${taskIds.map(id => 'task_ids=' + id).join('&')}`;
                        console.log('Generated URL for print version:', url);
                        window.open(url, '_blank');
                    });
                }
            });
        })();
    </script>
{% endblock %}